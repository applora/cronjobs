name: Deploy to Server

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Generate API Key
      id: generate-key
      run: |
        API_KEY=$(openssl rand -hex 16)
        echo "api_key=$API_KEY" >> $GITHUB_OUTPUT

    - name: Deploy to server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: 194.195.92.198
        username: root
        password: ${{ secrets.SERVER_PASSWORD }}
        script: |
          # Create directory if not exists
          mkdir -p /root/supercrawler
          cd /root/supercrawler

          # Backup current version if exists
          if [ -d ".git" ]; then
            git stash
            git pull origin main
          else
            # Clone the repository
            git clone https://github.com/${{ github.repository }}.git .
          fi

          # Create .env file with secrets
          cat > .env << EOF
          NODE_ENV=production
          REDIS_URL=redis://redis:6379
          PORT=3000
          HOST=${{ secrets.HOST }}
          API_KEY=${{ steps.generate-key.outputs.api_key }}
          EOF

          # Stop existing containers
          docker-compose down 2>/dev/null || true

          # Remove old images to free space
          docker system prune -f

          # Build and start services
          docker-compose up -d --build

          # Wait for services to be ready
          sleep 10

          # Show status
          docker-compose ps

          # Show logs
          docker-compose logs --tail=50

          echo "Deployment completed successfully!"
          echo "API Key generated: ${{ steps.generate-key.outputs.api_key }}"
          echo "Access your application at: https://${{ secrets.HOST }}"

    - name: Display deployment info
      run: |
        echo "âœ… Deployment completed!"
        echo "ğŸ”‘ Generated API Key: ${{ steps.generate-key.outputs.api_key }}"
        echo "ğŸŒ Application URL: https://${{ secrets.HOST }}"
        echo "ğŸ“Š Traefik Dashboard: http://194.195.92.198:8080"